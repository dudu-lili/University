<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redtourism.mapper.FeedbackMapper">
    <!-- 插入反馈 -->
    <insert id="insertFeedback" parameterType="Feedback" useGeneratedKeys="true" keyProperty="feedbackId">
        INSERT INTO feedback (user_id, feedback_type, content,create_time)
        VALUES (#{userId}, #{feedbackType}, #{content},#{createTime})
    </insert>

    <!-- 更新为处理中 -->
    <update id="startProcessing">
        UPDATE feedback
        SET status = 'processing',
            admin_id = #{adminId},
            process_time = NOW()
        WHERE feedback_id = #{feedbackId}
    </update>

    <!-- 更新为已解决 -->
    <update id="markResolved">
        UPDATE feedback
        SET status = 'resolved',
            resolve_time = NOW()
        WHERE feedback_id = #{feedbackId}
    </update>


    <!-- 条件查询 -->
    <select id="selectFeedback" resultType="Feedback">
        SELECT * FROM feedback
        <where>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <!--<if test="startDate != null">-->
                <!--AND create_time &gt;= #{startDate}-->
            <!--</if>-->
            <!--<if test="endDate != null">-->
                <!--AND create_time &lt;= #{endDate}-->
            <!--</if>-->
            <if test="startDate != null">
                AND create_time &gt;= CONCAT(#{startDate}, ' 00:00:00')
            </if>
            <if test="endDate != null">
                AND create_time &lt;= CONCAT(#{endDate}, ' 23:59:59')
            </if>
            <if test="keyword != null and keyword != ''">
                AND (feedback_type LIKE CONCAT('%', #{keyword}, '%')
                OR content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="feedbackType != null and feedbackType != ''">
                AND feedback_type = #{feedbackType}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>
    <!--<select id="selectFeedback" resultType="Feedback">-->
        <!--SELECT * FROM feedback-->
        <!--<where>-->
            <!--<if test="status != null and status != ''">-->
                <!--AND status = #{status}-->
            <!--</if>-->
            <!--<if test="userId != null">-->
                <!--AND user_id = #{userId}-->
            <!--</if>-->
            <!--<if test="startDate != null and endDate != null">-->
                <!--AND create_time BETWEEN #{startDate} AND #{endDate}-->
            <!--</if>-->
            <!--<if test="keyword != null and keyword != ''">-->
                <!--AND (feedback_type LIKE CONCAT('%', #{keyword}, '%')-->
                <!--OR content LIKE CONCAT('%', #{keyword}, '%'))-->
            <!--</if>-->
            <!--<if test="feedbackType != null and feedbackType != ''">-->
                <!--AND feedback_type = #{feedbackType}-->
            <!--</if>-->
        <!--</where>-->
        <!--ORDER BY create_time DESC-->
    <!--</select>-->
    <!-- 删除反馈 -->
    <delete id="deleteFeedback">
        DELETE FROM feedback WHERE feedback_id = #{feedbackId}
    </delete>

    <!-- 批量删除 -->
    <delete id="batchDeleteFeedback">
        DELETE FROM feedback WHERE feedback_id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>