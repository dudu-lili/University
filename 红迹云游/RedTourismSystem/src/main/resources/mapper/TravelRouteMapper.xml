<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redtourism.mapper.TravelRouteMapper">
    <select id="selectAll" resultType="TravelRoute">
        SELECT * FROM travel_route
    </select>

    <select id="selectById" resultType="TravelRoute">
        SELECT * FROM travel_route WHERE id = #{id}
    </select>

<!--    <insert id="insert" parameterType="TravelRoute" useGeneratedKeys="true" keyProperty="id">-->
<!--        INSERT INTO travel_route (name, cover_image, description, like_count)-->
<!--        VALUES (#{name},  #{coverImage,jdbcType=BLOB}, , #{description}, #{likeCount})-->
<!--    </insert>-->

<!--    <update id="update" parameterType="TravelRoute">-->
<!--        UPDATE travel_route SET-->
<!--                                name = #{name},-->
<!--                                cover_image =  #{coverImage,jdbcType=BLOB},-->
<!--                                description = #{description}-->
<!--        WHERE id = #{id}-->
<!--    </update>-->
    <insert id="insert" parameterType="TravelRoute" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO travel_route (name, cover_image, description, like_count)
        VALUES (#{name}, #{coverImage}, #{description}, #{likeCount})
    </insert>

    <update id="update" parameterType="TravelRoute">
        UPDATE travel_route
        SET
        name = #{name},
        description = #{description},
        <if test="coverImage != null">
            cover_image = #{coverImage}

        </if>
        WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM travel_route WHERE id = #{id}
    </delete>

    <update id="increaseLikeCount">
        UPDATE travel_route SET like_count = like_count + 1 WHERE id = #{id}
    </update>

    <select id="selectTopRoutes" resultType="TravelRoute">
        SELECT * FROM travel_route ORDER BY like_count DESC LIMIT #{limit}
    </select>
    <select id="listFavoritesByUserId" resultType="TravelRoute">
        SELECT tr.* FROM travel_route tr
                             JOIN favorite f ON tr.id = f.route_id
        WHERE f.user_id = #{userId}
    </select>
    <select id="getLikeCountByRouteId" resultType="int">
        SELECT like_count FROM travel_route WHERE id = #{routeId}
    </select>
    <select id="checkIfFavorited" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM favorite
        WHERE user_id = #{userId} AND route_id = #{routeId}
    </select>
    <update id="decreaseLikeCount">
        UPDATE travel_route
        SET like_count =
                CASE
                    WHEN like_count > 0 THEN like_count - 1
                    ELSE 0
                    END
        WHERE id = #{id}
    </update>
    <delete id="batchDelete">
        DELETE FROM travel_route WHERE id IN
        <foreach collection="routeIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>