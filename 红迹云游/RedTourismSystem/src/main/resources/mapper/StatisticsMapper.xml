<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- StatisticsMapper.xml -->
<mapper namespace="com.redtourism.mapper.StatisticsMapper">
    <!-- 用户统计 -->
    <select id="selectTotalUsers" resultType="int">
        SELECT COUNT(*) FROM user
    </select>

    <select id="selectTodayNewUsers" resultType="int">
        SELECT COUNT(*) FROM user
        WHERE DATE(create_time) = CURDATE()
    </select>

    <!-- 收藏前三景点 -->
    <select id="selectTop3FavoritedScenics" resultType="map">
        SELECT s.id, s.name, COUNT(f.id) AS favorite_count
        FROM scenic_spot s
        LEFT JOIN favorite f ON s.id = f.scenic_id
        GROUP BY s.id
        ORDER BY favorite_count DESC
        LIMIT 3
    </select>

    <!-- 评论前十景点 -->
    <select id="selectTop10CommentedScenics" resultType="map">
        SELECT s.id, s.name, COUNT(c.id) AS comment_count
        FROM scenic_spot s
        LEFT JOIN comment c ON s.id = c.scenic_id
        GROUP BY s.id
        ORDER BY comment_count DESC
        LIMIT 10
    </select>

    <!-- 最多景点省份（直接使用province字段） -->
    <select id="selectProvinceWithMostScenics" resultType="map">
    SELECT
        province,
        COUNT(*) AS scenic_count
    FROM scenic_spot
    GROUP BY province
    ORDER BY scenic_count DESC
    LIMIT 1
</select>

    <!--&lt;!&ndash; 地图坐标数据 &ndash;&gt;-->
    <!--<select id="selectAllScenicCoordinates" resultType="map">-->
        <!--SELECT name, address-->
        <!--FROM scenic_spot-->
    <!--</select>-->

    <!-- 新增以下SQL查询 -->
    <!-- 用户增长趋势（按天） -->
    <select id="selectUserGrowthTrend" resultType="map" parameterType="int">
    SELECT
        DATE(create_time) AS date,
        COUNT(*) AS count
    FROM user
    WHERE create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
    GROUP BY DATE(create_time)
    ORDER BY date
</select>

    <!-- 互动趋势（评论+收藏+点赞） -->
    <select id="selectInteractionTrend" resultType="map" parameterType="int">
    SELECT
        DATE(create_time) AS date,
        SUM(CASE WHEN type = 'comment' THEN 1 ELSE 0 END) AS comments,
        SUM(CASE WHEN type = 'favorite' THEN 1 ELSE 0 END) AS favorites,
        SUM(CASE WHEN type = 'like' THEN 1 ELSE 0 END) AS likes
    FROM (
        SELECT 'comment' AS type, create_time FROM comment
        UNION ALL
        SELECT 'favorite' AS type, create_time FROM favorite
        UNION ALL
        SELECT 'like' AS type, create_time FROM `like`
    ) AS interactions
    WHERE create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
    GROUP BY DATE(create_time)
    ORDER BY date
</select>
    <!-- 用户行为统计数据 -->
    <select id="selectUserBehaviorStats" resultType="map">
    SELECT
        (SELECT COUNT(*) FROM comment) AS comment_count,
        (SELECT COUNT(*) FROM favorite) AS favorite_count,
        (SELECT COUNT(*) FROM `like`) AS like_count,
        (SELECT SUM(view_count) FROM news) AS news_view_count,
        (SELECT SUM(view_count) FROM study) AS study_view_count,
        (SELECT SUM(like_count) FROM scenic_spot) AS scenic_like_count,
        (SELECT SUM(like_count) FROM travel_route) AS route_like_count
</select>

    <select id="selectScenicDistributionByProvince" resultType="map">
    SELECT province as name, COUNT(*) as value
    FROM scenic_spot
    GROUP BY province
</select>


</mapper>